# Golden Test Data

This directory contains test input files and expected outputs for golden file testing.
These files are tracked in git to detect unintended changes in the controller's output.

## Directory Structure

- `*-input.yaml`: Input CRDs (RoleDefinition, BindDefinition, WebhookAuthorizer)
- `expected/`: Expected output resources generated by the controller

## Test Files

### RoleDefinition Tests

| Input File | Description |
|------------|-------------|
| `roledefinition-clusterrole-input.yaml` | Basic ClusterRole generation with restricted verbs |
| `roledefinition-namespaced-role-input.yaml` | Namespaced Role generation |
| `roledefinition-restricted-apis-input.yaml` | Excludes entire API groups (apps, batch, autoscaling) |
| `roledefinition-restricted-resources-input.yaml` | Excludes specific resources (secrets, configmaps) |

### BindDefinition Tests

| Input File | Description |
|------------|-------------|
| `binddefinition-clusterrolebinding-input.yaml` | Basic ClusterRoleBinding with User/Group subjects |
| `binddefinition-rolebinding-input.yaml` | Namespaced RoleBinding |
| `binddefinition-serviceaccount-input.yaml` | Auto-creates ServiceAccount if missing |
| `binddefinition-multi-clusterroles-input.yaml` | Creates multiple ClusterRoleBindings from one CR |
| `binddefinition-mixed-subjects-input.yaml` | User, Group, and ServiceAccount subjects together |
| `binddefinition-rolebinding-namespace-selector-input.yaml` | RoleBindings with namespace label selector |
| `binddefinition-rolebinding-explicit-namespace-input.yaml` | RoleBindings in explicit namespaces |

### WebhookAuthorizer Tests

| Input File | Description |
|------------|-------------|
| `webhookauthorizer-allow-input.yaml` | Basic allow rule for specific user |
| `webhookauthorizer-deny-input.yaml` | Basic deny configuration |
| `webhookauthorizer-nonresource-input.yaml` | NonResourceURLs authorization |
| `webhookauthorizer-group-based-input.yaml` | Group-based authorization rules |
| `webhookauthorizer-namespace-selector-input.yaml` | Namespace-scoped authorization |
| `webhookauthorizer-deny-list-input.yaml` | Explicit deny list principals |

## Test Workflow

1. Apply input YAML to cluster
2. Wait for controller to reconcile
3. Fetch generated resource
4. Compare with expected output (ignoring dynamic fields like timestamps)

## Updating Expected Files

When updating controller behavior:
1. Run tests to see failures
2. Review the differences carefully
3. Update expected files if changes are intentional
4. Commit changes with explanation

## Running Golden Tests

```bash
# Run only golden file tests
go test ./test/e2e/... -ginkgo.label-filter="golden" --ginkgo.v
```

