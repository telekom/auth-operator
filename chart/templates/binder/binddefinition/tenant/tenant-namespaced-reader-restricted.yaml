{{- $enforceAutomationGlobal := default "false" $.Values.global.enforceAutomationGlobal }}
{{- $enforceAutomationCluster := $.Values.global.enforceAutomationCluster | default "" }}
{{- $enforceAutomation := $enforceAutomationGlobal }}
{{- if ne $enforceAutomationCluster "" }}
  {{- $enforceAutomation = $enforceAutomationCluster }}
{{- end }}
{{- range $index, $authBackend := .Values.global.cluster.authBackends }}
---
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: {{ $authBackend.name }}-bd-tenant-namespaced-reader-restricted
spec:
  targetName: {{ $authBackend.name }}-bd-tenant-ns-reader-restricted
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_namespaced_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_namespaced_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_namespaced_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    {{- if eq $enforceAutomation "false" }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_namespaced_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_namespaced_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_namespaced_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_namespaced_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_namespaced_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_namespaced_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    {{- else }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_m2m_namespaced_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_m2m_namespaced_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_m2m_namespaced_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_m2m_namespaced_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_m2m_namespaced_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_m2m_namespaced_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_m2m_namespaced_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_m2m_namespaced_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_m2m_namespaced_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    {{- end }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_cluster_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_cluster_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_cluster_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    {{- if eq $enforceAutomation "false" }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_cluster_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_cluster_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_cluster_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_cluster_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_cluster_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_cluster_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    {{- else }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_m2m_cluster_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_m2m_cluster_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_m2m_cluster_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_m2m_cluster_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_m2m_cluster_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_m2m_cluster_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.tenant $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_m2m_cluster_reader" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_m2m_cluster_collaborator" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ (printf "oidc:%s%s_%s_%s_%s_m2m_cluster_poweruser" $authBackend.oidcGroupNamePrefix $.Values.global.cluster.name $.Values.global.cluster.tenant $.Values.global.cluster.location $.Values.global.cluster.environment) | replace "_" $authBackend.oidcGroupNameDelimiter }}
    {{- end }}
    - kind: ServiceAccount
      namespace: kube-system
      name: m2m-sa-t-caas-{{ $.Values.global.cluster.tenant }}
  roleBindings:
    clusterRoleRefs:
    - apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole 
      name: t-caas-tenant-namespaced-reader-restricted
    namespaceSelector:
    - matchExpressions:
      - key: kubernetes.io/metadata.name
        operator: In
        values:
          - kube-system
          - kube-public
          - kube-node-lease
    - matchExpressions:
      - key: t-caas.telekom.com/owner
        operator: In
        values:
          - platform
      {{- $thirdParties := list }}
      {{- if eq $.Values.global.thirdPartyGlobal "true" }}
        {{- $globalThirdParties := default (list) $.Values.global.thirdParties }}
        {{- $thirdParties = concat $thirdParties $globalThirdParties }}
      {{- end }}
      {{- if eq $.Values.global.thirdPartyCluster "true" }}
        {{- $clusterThirdParties := default (list) $.Values.global.cluster.thirdParties }}
        {{- $thirdParties = concat $thirdParties $clusterThirdParties }}
      {{- end }}
    {{- if gt (len $thirdParties) 0 }}
    {{- range $item := $thirdParties }}
    - matchExpressions:
      - key: t-caas.telekom.com/owner
        operator: In
        values:
          - thirdparty
      - key: t-caas.telekom.com/thirdparty
        operator: In 
        values:
          - {{ $item }}
      - key: t-caas.telekom.com/owner
        operator: NotIn 
        values:
          - tenant 
      - key: t-caas.telekom.com/tenant 
        operator: NotIn 
        values:
          - {{ $.Values.global.cluster.tenant }}
    {{- end }}
    {{- end }}
{{- end }}
