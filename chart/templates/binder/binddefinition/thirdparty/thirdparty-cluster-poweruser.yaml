{{- $thirdPartyGlobal := default "false" $.Values.global.thirdPartyGlobal }}
{{- $thirdPartyCluster := $.Values.global.thirdPartyCluster | default "" }}
{{- $thirdParties := list }}
{{- $thirdParty := $thirdPartyGlobal }}
  {{- $globalThirdParties := default (list) $.Values.global.thirdParties }}
  {{- $thirdParties = concat $thirdParties $globalThirdParties }}
{{- if ne $thirdPartyCluster "" }}
  {{- $thirdParty = $thirdPartyCluster }}
    {{- $clusterThirdParties := default (list) $.Values.global.cluster.thirdParties }}
    {{- $thirdParties = concat $thirdParties $clusterThirdParties }}
{{- end }}
{{- $enforceAutomationGlobal := default "false" $.Values.global.enforceAutomationGlobal }}
{{- $enforceAutomationCluster := $.Values.global.enforceAutomationCluster | default "" }}
{{- $enforceAutomation := $enforceAutomationGlobal }}
{{- if ne $enforceAutomationCluster "" }}
  {{- $enforceAutomation = $enforceAutomationCluster }}
{{- end }}
{{- if eq $thirdParty "true" }}
{{- range $index, $authBackend := .Values.global.cluster.authBackends }}
{{- if gt (len $thirdParties) 0 }}
{{- range $item := $thirdParties }}
---
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: {{ $authBackend.name }}-bd-thirdparty-{{ $item }}-cluster-poweruser
spec:
  targetName: {{ $authBackend.name }}-bd-thirdparty-{{ $item }}-cl-poweruser
  subjects:
    {{- if eq $enforceAutomation "false" }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ regexReplaceAll "[-_]" (printf "oidc:%sthirdparty_%s_cluster_poweruser" $authBackend.oidcGroupNamePrefix $item) $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ regexReplaceAll "[-_]" (printf "oidc:%sthirdparty_%s_%s_cluster_poweruser" $authBackend.oidcGroupNamePrefix $item $.Values.global.cluster.environment) $authBackend.oidcGroupNameDelimiter }}
    {{- else }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ regexReplaceAll "[-_]" (printf "oidc:%sthirdparty_%s_m2m_cluster_poweruser" $authBackend.oidcGroupNamePrefix $item) $authBackend.oidcGroupNameDelimiter }}
    - apiGroup: rbac.authorization.k8s.io
      kind: Group 
      name: {{ regexReplaceAll "[-_]" (printf "oidc:%sthirdparty_%s_%s_m2m_cluster_poweruser" $authBackend.oidcGroupNamePrefix $item $.Values.global.cluster.environment) $authBackend.oidcGroupNameDelimiter }}
    {{- end }}
    - kind: ServiceAccount
      namespace: kube-system
      name: m2m-sa-t-caas-thirdparty-{{ $item }}
  clusterRoleBindings:
    clusterRoleRefs:
    - apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole 
      name: t-caas-thirdparty-{{ $item }}-cluster-poweruser
{{- end }}
{{- end }}
{{- end }}
{{- end }}
