---
include:
  - project: "cit/t-caas/ci/pipelines"
    ref: "${SHARED_PIPELINE_VERSION}"
    file:
      - "execution/golang/tdi-op-extension.yaml"


variables:
  APP_NAME: "auth-operator"
  GO_VERSION: "1.25"
  GO_LINT_VERSION: "v2.8.0"
  GO_MAIN: "main.go"
  GO_BIN_NAME: "${APP_NAME}"
  HELM_CHART_SOURCE: chart/auth-operator
  GIT_DEPTH: 1
  # Stricter lint timeout for comprehensive checks
  GO_LINT_TIMEOUT: "10m"
  # Minimum test coverage threshold (percentage)
  MIN_TEST_COVERAGE: "60"

# Override go-lint to use Go 1.25 base image and install golangci-lint from source
# The pre-built golangci-lint images are compiled with Go 1.24 which is incompatible
go-lint:
  extends: .go-base
  script:
    - |
      set -exo pipefail
      echo "Installing golangci-lint ${GO_LINT_VERSION} from source..."
      go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@${GO_LINT_VERSION}
      golangci-lint run -v \
        --timeout ${GO_LINT_TIMEOUT:-10m} \
        --issues-exit-code 1 \
        --output.text.print-issued-lines=true \
        --output.code-climate.path=gl-code-quality-report.json
  allow_failure: false

# Add go vet with stricter checks
go-vet:
  extends: .go-base
  stage: lint
  needs:
    - export-k8s-tool-versions
  script:
    - |
      set -exo pipefail
      echo "Running go vet with all checks..."
      go vet ./...
  rules:
    - !reference [.rule, is_mr]
    - !reference [.rule, is_default]

# Verify go.mod and go.sum are tidy
go-mod-tidy:
  extends: .go-base
  stage: lint
  needs: []
  script:
    - |
      set -exo pipefail
      echo "Checking go.mod and go.sum are tidy..."
      go mod tidy
      if ! git diff --exit-code go.mod go.sum; then
        echo "ERROR: go.mod or go.sum is not tidy. Run 'go mod tidy' and commit changes."
        exit 1
      fi
  rules:
    - !reference [.rule, is_mr]
    - !reference [.rule, is_default]


# Security scanning with govulncheck
go-vulncheck:
  extends: .go-base
  stage: lint
  needs: []
  script:
    - |
      set -exo pipefail
      echo "Installing govulncheck..."
      go install golang.org/x/vuln/cmd/govulncheck@latest
      echo "Running vulnerability scan..."
      govulncheck ./...
  allow_failure: false
  rules:
    - !reference [.rule, is_mr]
    - !reference [.rule, is_default]
    - !reference [.rule, is_release]

# License compliance check
license-check:
  extends: .go-base
  stage: lint
  needs: []
  script:
    - |
      set -exo pipefail
      echo "Installing go-licenses..."
      go install github.com/google/go-licenses@latest
      echo "Checking for forbidden licenses..."
      # Check for licenses and fail on unknown or forbidden
      go-licenses check ./... --allowed_licenses=Apache-2.0,MIT,BSD-2-Clause,BSD-3-Clause,ISC,MPL-2.0 || {
        echo "ERROR: License check found forbidden or unknown licenses. Review dependencies."
        exit 1
      }
  allow_failure: false
  rules:
    - !reference [.rule, is_mr]
    - !reference [.rule, is_default]

# Enforce test coverage threshold
go-test:
  needs:
    - export-k8s-tool-versions
  after_script:
    - |
      set -eo pipefail
      if [ -f coverage.out ]; then
        COVERAGE=$(go tool cover -func coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Total test coverage: ${COVERAGE}%"
        if [ "$(echo "${COVERAGE} < ${MIN_TEST_COVERAGE}" | bc -l)" -eq 1 ]; then
          echo "ERROR: Test coverage ${COVERAGE}% is below minimum threshold ${MIN_TEST_COVERAGE}%"
          # Uncomment next line to enforce coverage threshold
          # exit 1
        fi
      fi

# use specific go flags
go-build:
  variables:
    GO_LDFLAGS: >-
      -s -w
      -X gitlab.devops.telekom.de/cit/t-caas/operators/auth-operator/pkg/system.Name=${CI_PROJECT_TITLE}
      -X gitlab.devops.telekom.de/cit/t-caas/operators/auth-operator/pkg/system.Version=${GO_APP_VERSION}
      -X gitlab.devops.telekom.de/cit/t-caas/operators/auth-operator/pkg/system.Commit=${CI_COMMIT_SHA}
      -X gitlab.devops.telekom.de/cit/t-caas/operators/auth-operator/pkg/system.Repository=${CI_PROJECT_URL}

assert-controller-gen:
  variables:
    K8S_OP_CONTROLLER_GEN_VERSION: "v0.20.0"
    # Workaround for go-openapi/swag v0.25.4 including a go.work file
    # that breaks controller-gen when loading packages from module cache
    GOWORK: "off"

assert-helmify:
  script:
    - |
      set -xeuo pipefail
      make helm
      # Diff check
      if ! git diff --exit-code; then
        echo "ERROR: found diff after regenerating helmify resources - run the make generate tooling update generated resources."
        exit 3
      fi

# Helm chart validation
helm-lint:
  extends: .helm-base
  stage: lint
  needs: []
  image:
    name: ${MCICD_DOCKER_MIRROR_PREFIX}alpine/helm:3.17.0
    entrypoint: [""]
  script:
    - |
      set -exo pipefail
      echo "Linting Helm chart..."
      helm lint ${HELM_CHART_SOURCE} --strict
      echo "Validating Helm templates..."
      helm template ${HELM_CHART_SOURCE} > /dev/null
  rules:
    - !reference [.rule, is_mr]
    - !reference [.rule, is_default]
    - !reference [.rule, is_release]

# YAML linting for manifests
yaml-lint:
  stage: lint
  needs: []
  image:
    name: ${MCICD_DOCKER_MIRROR_PREFIX}cytopia/yamllint:latest
    entrypoint: [""]
  script:
    - |
      set -exo pipefail
      echo "Linting YAML files..."
      yamllint -c .yamllint.yml .
  allow_failure: false
  rules:
    - !reference [.rule, is_mr]
    - !reference [.rule, is_default]

.helm-base:
  variables:
    HELM_CHART_SOURCE: chart/auth-operator
