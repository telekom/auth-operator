# SPDX-FileCopyrightText: 2026 Deutsche Telekom AG
#
# SPDX-License-Identifier: Apache-2.0

# =============================================================================
# BindDefinition Samples - Comprehensive Feature Coverage
# =============================================================================
# These samples demonstrate all features of the BindDefinition CRD:
# - Multiple subject types: User, Group, ServiceAccount
# - ClusterRoleBindings (cluster-wide access)
# - RoleBindings with namespace selectors (dynamic namespace targeting)
# - RoleBindings with specific namespaces
# - Multiple namespace selectors with complex label matching
# - Cross-namespace service account bindings
#
# Edge-case / conflict scenarios (bd-edge-* prefix):
# - Pre-existing roles that clash with RoleDefinition-generated roles
# - Pre-existing ServiceAccounts referenced as subjects
# - The same pre-existing SA bound by multiple BindDefinitions
# - BD-generated ServiceAccounts (operator auto-creates them)
# - BD-generated SA shared by multiple BindDefinitions
# - Deliberate missing ClusterRole / Role references (RoleRefsValid: False)
# - Mixed valid + missing role references
# =============================================================================

---
# -----------------------------------------------------------------------------
# Platform Admins - Full administrative access
# Binds platform admin group to cluster-wide and namespace-specific roles
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-platform-admins
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/privilege-level: admin
spec:
  targetName: platform-admins
  subjects:
    # Platform admin group from IdP
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: platform-admins@example.com
    # Individual admin users
    - apiGroup: rbac.authorization.k8s.io
      kind: User
      name: admin1@example.com
    - apiGroup: rbac.authorization.k8s.io
      kind: User
      name: admin2@example.com
    # Platform automation service account
    - kind: ServiceAccount
      name: platform-controller
      namespace: t-caas-system
  # Cluster-wide admin access via ClusterRoleBindings
  clusterRoleBindings:
    clusterRoleRefs:
      - t-caas-platform-admin-reader
      - t-caas-tenant-operator
  # Namespace-specific admin access via RoleBindings
  roleBindings:
    # Full access to all platform namespaces
    - clusterRoleRefs:
        - admin
      namespaceSelector:
        - matchLabels:
            t-caas.telekom.com/owner: platform
        - matchExpressions:
            - key: kubernetes.io/metadata.name
              operator: In
              values:
                - t-caas-system
                - t-caas-monitoring
                - t-caas-logging

---
# -----------------------------------------------------------------------------
# Tenant Alpha Team - Multi-tier access for a specific tenant
# Demonstrates complex namespace selection with multiple selectors
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-tenant-alpha-team
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/tenant: alpha
spec:
  targetName: tenant-alpha
  subjects:
    # Tenant admin group
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: tenant-alpha-admins@example.org
    # Development team
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: tenant-alpha-developers@example.org
    # Individual power users
    - apiGroup: rbac.authorization.k8s.io
      kind: User
      name: lead-developer@example.org
    # CI/CD service accounts from different namespaces
    - kind: ServiceAccount
      name: ci-runner
      namespace: tenant-alpha-cicd
    - kind: ServiceAccount
      name: argocd-application-controller
      namespace: tenant-alpha-gitops
  # Cluster-wide read access
  clusterRoleBindings:
    clusterRoleRefs:
      - view
      - t-caas-security-auditor
  roleBindings:
    # Developer access to dev/staging namespaces
    - clusterRoleRefs:
        - edit
      roleRefs:
        - t-caas-namespace-developer
      namespaceSelector:
        - matchLabels:
            t-caas.telekom.com/tenant: alpha
            t-caas.telekom.com/environment: development
        - matchLabels:
            t-caas.telekom.com/tenant: alpha
            t-caas.telekom.com/environment: staging
    # Read-only access to production namespaces
    - clusterRoleRefs:
        - view
      roleRefs:
        - t-caas-namespace-viewer
      namespaceSelector:
        - matchLabels:
            t-caas.telekom.com/tenant: alpha
            t-caas.telekom.com/environment: production
    # Full access to CI/CD namespaces only
    - clusterRoleRefs:
        - admin
      namespaceSelector:
        - matchExpressions:
            - key: t-caas.telekom.com/tenant
              operator: In
              values:
                - alpha
            - key: t-caas.telekom.com/purpose
              operator: In
              values:
                - cicd
                - gitops
                - build

---
# -----------------------------------------------------------------------------
# Cross-Tenant Auditors - Security team with cross-cutting access
# Demonstrates Group-based access with exclusions via namespace selectors
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-security-auditors
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/privilege-level: auditor
spec:
  targetName: security-auditors
  subjects:
    # Security team groups from multiple IdP sources
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: security-team@example.com
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: compliance-auditors@example.com
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: soc-analysts@example.com
    # External audit service account
    - kind: ServiceAccount
      name: external-auditor
      namespace: audit-system
  clusterRoleBindings:
    clusterRoleRefs:
      - t-caas-security-auditor
  roleBindings:
    # Read access to all tenant namespaces
    - clusterRoleRefs:
        - view
      namespaceSelector:
        - matchExpressions:
            - key: t-caas.telekom.com/owner
              operator: In
              values:
                - tenant
                - shared
            - key: t-caas.telekom.com/tenant
              operator: Exists
    # Additional secret-viewing rights for compliance namespaces.
    # NOTE: "secret-reader" is deliberately NOT created by any RoleDefinition —
    # this exercises the RoleRefsValid: False condition (missing Role reference).
    - roleRefs:
        - secret-reader
      namespaceSelector:
        - matchLabels:
            t-caas.telekom.com/compliance-scope: pci-dss

---
# -----------------------------------------------------------------------------
# Monitoring Stack - Service account bindings for observability
# Demonstrates ServiceAccount-only bindings with specific namespace targeting
# Also tests automountServiceAccountToken feature (set to true for monitoring)
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-monitoring-stack
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/component: monitoring
spec:
  targetName: monitoring-stack
  # Enable automount for monitoring SAs that need API access
  automountServiceAccountToken: true
  subjects:
    # Prometheus service account
    - kind: ServiceAccount
      name: prometheus
      namespace: t-caas-monitoring
    # Grafana service account
    - kind: ServiceAccount
      name: grafana
      namespace: t-caas-monitoring
    # Alertmanager service account
    - kind: ServiceAccount
      name: alertmanager
      namespace: t-caas-monitoring
    # Thanos components
    - kind: ServiceAccount
      name: thanos-query
      namespace: t-caas-monitoring
    - kind: ServiceAccount
      name: thanos-store
      namespace: t-caas-monitoring
  # Cluster-wide metrics access
  clusterRoleBindings:
    clusterRoleRefs:
      - system:monitoring
  roleBindings:
    # Access to scrape endpoints in all application namespaces
    - clusterRoleRefs:
        - view
      namespaceSelector:
        - matchExpressions:
            - key: t-caas.telekom.com/monitoring
              operator: In
              values:
                - enabled
                - required
    # Special access to kube-system for cluster metrics (specific namespace, not selector)
    - clusterRoleRefs:
        - view
      namespace: kube-system

---
# -----------------------------------------------------------------------------
# GitOps Controllers - ArgoCD/Flux access patterns
# Demonstrates automation service account bindings
# Note: GitOps controllers typically require API access (automountServiceAccountToken default true)
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-gitops-controllers
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/component: gitops
spec:
  targetName: gitops-controllers
  # Use default automount to allow API access for GitOps controllers
  subjects:
    # ArgoCD components
    - kind: ServiceAccount
      name: argocd-application-controller
      namespace: argocd
    - kind: ServiceAccount
      name: argocd-server
      namespace: argocd
    - kind: ServiceAccount
      name: argocd-repo-server
      namespace: argocd
    # Flux components
    - kind: ServiceAccount
      name: source-controller
      namespace: flux-system
    - kind: ServiceAccount
      name: kustomize-controller
      namespace: flux-system
    - kind: ServiceAccount
      name: helm-controller
      namespace: flux-system
  # Cluster-wide resource management
  clusterRoleBindings:
    clusterRoleRefs:
      - cluster-admin
  roleBindings:
    # Full control of managed namespaces (uses selector)
    - clusterRoleRefs:
        - admin
      namespaceSelector:
        - matchExpressions:
            - key: argocd.argoproj.io/managed-by
              operator: Exists
        - matchExpressions:
            - key: kustomize.toolkit.fluxcd.io/managed-by
              operator: Exists
    # Read access to argocd namespace (uses specific namespace, not selector)
    - clusterRoleRefs:
        - view
      namespace: argocd
    # Read access to flux-system namespace (uses specific namespace, not selector)
    - clusterRoleRefs:
        - view
      namespace: flux-system

---
# -----------------------------------------------------------------------------
# Default Namespace Test - Simple binding for testing in default namespace
# Ensures RoleBindings are created in commonly existing namespaces
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-default-ns-test
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: testing
spec:
  targetName: default-ns-test
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: developers@example.com
    # ServiceAccount that will be auto-created
    - kind: ServiceAccount
      name: test-automation
      namespace: default
  roleBindings:
    # Bind to default namespace (always exists in any cluster)
    - clusterRoleRefs:
        - view
      namespace: default
    # Bind to kube-public namespace (always exists in any cluster)
    - clusterRoleRefs:
        - view
      namespace: kube-public

---
# -----------------------------------------------------------------------------
# Non-default automountServiceAccountToken sample
# Demonstrates explicit disablement for a read-only UI service account
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-readonly-ui
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: example
spec:
  targetName: readonly-ui
  # Explicitly disable automount for a non-controller UI workload
  automountServiceAccountToken: false
  subjects:
    - kind: ServiceAccount
      name: readonly-ui
      namespace: default
  roleBindings:
    - clusterRoleRefs:
        - view
      namespace: default

---
# -----------------------------------------------------------------------------
# Cluster-Only Binding - Tests ClusterRoleBinding without any RoleBindings
# Demonstrates a pure cluster-scoped binding scenario
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-cluster-only
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: testing
spec:
  targetName: cluster-only-access
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: cluster-readers@example.com
  # Only ClusterRoleBindings, no RoleBindings
  clusterRoleBindings:
    clusterRoleRefs:
      - view
      - t-caas-security-auditor

---
# -----------------------------------------------------------------------------
# Namespace-Only Binding - Tests RoleBindings without any ClusterRoleBindings
# Demonstrates a pure namespace-scoped binding scenario
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-namespace-only
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: testing
spec:
  targetName: namespace-only-access
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: namespace-developers@example.com
    - kind: ServiceAccount
      name: namespace-automation
      namespace: tenant-alpha
  # Only RoleBindings, no ClusterRoleBindings
  roleBindings:
    # Bind to RoleDefinition-created Role (t-caas-namespace-developer in tenant-alpha)
    - roleRefs:
        - t-caas-namespace-developer
      namespace: tenant-alpha
    # Also bind to built-in edit role
    - clusterRoleRefs:
        - edit
      namespace: tenant-alpha-staging

---
# -----------------------------------------------------------------------------
# Multi-Tenant Binding - Second binding to same RoleDefinition (1:N test)
# Tests that multiple BindDefinitions can reference the same Role/ClusterRole
# This binds DIFFERENT subjects to the SAME RoleDefinition-created roles
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-tenant-beta-team
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/tenant: beta
spec:
  targetName: tenant-beta
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: tenant-beta-developers@example.org
    - kind: ServiceAccount
      name: beta-automation
      namespace: tenant-beta
  # Bind to SAME ClusterRoles as tenant-alpha (tests 1:N relationship)
  clusterRoleBindings:
    clusterRoleRefs:
      - view
      - t-caas-security-auditor
      - t-caas-platform-admin-reader
  roleBindings:
    # Bind to RoleDefinition-created Role in tenant-beta namespace
    - roleRefs:
        - t-caas-namespace-viewer
      namespace: tenant-beta
    # Also use namespace selector
    - clusterRoleRefs:
        - edit
      namespaceSelector:
        - matchLabels:
            t-caas.telekom.com/tenant: beta

---
# -----------------------------------------------------------------------------
# Complex Selector Binding - Tests all matchExpression operators
# Exercises NotIn, DoesNotExist operators (if supported)
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-complex-selectors
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: testing
spec:
  targetName: complex-selector-test
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: advanced-users@example.com
  roleBindings:
    # Test In operator with multiple values
    - clusterRoleRefs:
        - view
      namespaceSelector:
        - matchExpressions:
            - key: t-caas.telekom.com/environment
              operator: In
              values:
                - development
                - staging
                - production
    # Test Exists operator
    - clusterRoleRefs:
        - view
      namespaceSelector:
        - matchExpressions:
            - key: t-caas.telekom.com/tenant
              operator: Exists
    # Test combined matchLabels AND matchExpressions
    - clusterRoleRefs:
        - edit
      namespaceSelector:
        - matchLabels:
            t-caas.telekom.com/owner: tenant
          matchExpressions:
            - key: t-caas.telekom.com/environment
              operator: In
              values:
                - development

---
# -----------------------------------------------------------------------------
# Multiple Selector Terms WITH Overlap - Same namespaces matched by multiple terms
# Tests that overlapping selector terms are properly deduplicated
# This should create RoleBindings in:
# - tenant-alpha (matched by term 1 AND term 2 - overlap)
# - tenant-alpha-staging (matched by term 2 only)
# - tenant-alpha-prod (matched by term 2 only)
# - tenant-beta (matched by term 1 only)
# The controller should deduplicate and not create duplicate bindings
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-overlapping-selectors
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: testing
spec:
  targetName: overlapping-selector-test
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: overlap-test-users@example.com
  roleBindings:
    # Single roleBinding entry with MULTIPLE namespaceSelector terms that OVERLAP
    # Term 1: matches namespaces with environment=development (tenant-alpha)
    # Term 2: matches namespaces with tenant=alpha (tenant-alpha, tenant-alpha-staging, tenant-alpha-prod)
    # OVERLAP: tenant-alpha namespace matches BOTH terms
    - clusterRoleRefs:
        - view
      namespaceSelector:
        # Term 1: Development environments only
        - matchLabels:
            t-caas.telekom.com/environment: development
        # Term 2: All tenant-alpha namespaces (overlaps with term 1 on tenant-alpha namespace)
        - matchLabels:
            t-caas.telekom.com/tenant: alpha
        # Term 3: Also match tenant-beta for non-overlapping coverage
        - matchLabels:
            t-caas.telekom.com/tenant: beta

---
# -----------------------------------------------------------------------------
# Multiple Selector Terms WITHOUT Overlap - Disjoint namespace sets
# Tests that non-overlapping selector terms all contribute unique namespaces
# This should create RoleBindings in:
# - Platform namespaces (owner=platform): t-caas-system, t-caas-monitoring, t-caas-logging
# - GitOps namespaces (gitops-source=true): argocd, flux-system
# - Compliance namespaces (compliance-scope exists): compliance-pci
# No namespace should match multiple terms (no overlap)
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-disjoint-selectors
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: testing
spec:
  targetName: disjoint-selector-test
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: disjoint-test-users@example.com
  roleBindings:
    # Single roleBinding entry with MULTIPLE namespaceSelector terms that do NOT overlap
    # Each term matches completely different namespaces
    - clusterRoleRefs:
        - view
      namespaceSelector:
        # Term 1: Platform-owned namespaces
        - matchLabels:
            t-caas.telekom.com/owner: platform
        # Term 2: GitOps source namespaces (disjoint from platform)
        - matchLabels:
            t-caas.telekom.com/gitops-source: "true"
        # Term 3: Compliance namespaces (disjoint from both)
        - matchExpressions:
            - key: t-caas.telekom.com/compliance-scope
              operator: Exists

---
# -----------------------------------------------------------------------------
# Mixed Selector Types in Single RoleBinding - Combines namespace and selectors
# Tests mixing specific namespace with namespaceSelector in different roleBinding entries
# Also tests multiple roleBindings entries with different selector complexities
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-mixed-binding-types
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: testing
spec:
  targetName: mixed-binding-test
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: User
      name: mixed-test-user@example.com
  clusterRoleBindings:
    clusterRoleRefs:
      - t-caas-security-auditor
  roleBindings:
    # Entry 1: Specific namespace (no selector)
    - clusterRoleRefs:
        - view
      namespace: default
    # Entry 2: Single simple selector
    - clusterRoleRefs:
        - view
      namespaceSelector:
        - matchLabels:
            t-caas.telekom.com/owner: shared
    # Entry 3: Multiple overlapping selector terms (same as bd-overlapping-selectors pattern)
    - roleRefs:
        - t-caas-namespace-viewer
      namespaceSelector:
        - matchLabels:
            t-caas.telekom.com/environment: staging
        - matchLabels:
            t-caas.telekom.com/tenant: beta
    # Entry 4: Complex selector with matchLabels + matchExpressions combined
    - clusterRoleRefs:
        - edit
      namespaceSelector:
        - matchLabels:
            t-caas.telekom.com/owner: tenant
          matchExpressions:
            - key: t-caas.telekom.com/purpose
              operator: In
              values:
                - application
                - cicd

# #############################################################################
#  EDGE-CASE / CONFLICT SCENARIOS
# #############################################################################
# These samples deliberately exercise problematic situations:
#   - Pre-existing (not operator-managed) roles and service accounts
#   - Missing role references that trigger RoleRefsValid: False
#   - Multiple BindDefinitions sharing the same ServiceAccount subject
# Pre-existing resources are created by edge-case-prerequisites.yaml which
# must be applied BEFORE these BindDefinitions.
# #############################################################################

---
# -----------------------------------------------------------------------------
# Edge Case 1: Pre-existing ClusterRole
# References a ClusterRole ("pre-existing-reader") that was created manually,
# NOT by any RoleDefinition. Tests that BindDefinition happily binds to roles
# it does not own.
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-preexisting-role
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-preexisting-role
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: preexisting-role-consumers@example.com
  clusterRoleBindings:
    clusterRoleRefs:
      # This role exists before the operator starts — created by
      # edge-case-prerequisites.yaml
      - pre-existing-reader

---
# -----------------------------------------------------------------------------
# Edge Case 2: Pre-existing ServiceAccount used as a subject
# Binds a ServiceAccount ("pre-existing-sa" in tenant-alpha) that already exists
# in the cluster. The operator creates the binding but SKIPS the SA —
# it does not adopt (apply/own) a pre-existing ServiceAccount.
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-preexisting-sa
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-preexisting-sa
  subjects:
    - kind: ServiceAccount
      name: pre-existing-sa
      namespace: tenant-alpha
  clusterRoleBindings:
    clusterRoleRefs:
      - view

---
# -----------------------------------------------------------------------------
# Edge Case 3a: Shared pre-existing SA — first consumer
# Two BindDefinitions bind to the SAME pre-existing ServiceAccount
# ("shared-monitoring-sa" in t-caas-monitoring). Tests that deletion of one BD
# does NOT remove the SA because the other BD still references it.
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-shared-sa-consumer-a
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-shared-sa-a
  subjects:
    - kind: ServiceAccount
      name: shared-monitoring-sa
      namespace: t-caas-monitoring
  clusterRoleBindings:
    clusterRoleRefs:
      - view

---
# -----------------------------------------------------------------------------
# Edge Case 3b: Shared pre-existing SA — second consumer
# Same SA as 3a, different roles.
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-shared-sa-consumer-b
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-shared-sa-b
  subjects:
    - kind: ServiceAccount
      name: shared-monitoring-sa
      namespace: t-caas-monitoring
  clusterRoleBindings:
    clusterRoleRefs:
      - t-caas-security-auditor

---
# -----------------------------------------------------------------------------
# Edge Case 4: BD-generated ServiceAccount
# References a ServiceAccount ("generated-deploy-sa" in tenant-beta) that does
# NOT exist yet. The operator should auto-create it and track it in
# status.generatedServiceAccounts.
# Also sets automountServiceAccountToken: false to exercise that option.
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-generated-sa
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-generated-sa
  automountServiceAccountToken: false
  subjects:
    - kind: ServiceAccount
      name: generated-deploy-sa
      namespace: tenant-beta
  clusterRoleBindings:
    clusterRoleRefs:
      - view
  roleBindings:
    - clusterRoleRefs:
        - edit
      namespace: tenant-beta

---
# -----------------------------------------------------------------------------
# Edge Case 5a: BD-generated SA shared by multiple BDs — first owner
# Two BDs reference the same non-existent SA ("shared-generated-sa" in
# tenant-alpha). Both should attempt to ensure it via SSA (idempotent).
# Deletion of one BD must NOT delete the SA while the other still needs it.
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-shared-generated-sa-a
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-shared-gen-a
  subjects:
    - kind: ServiceAccount
      name: shared-generated-sa
      namespace: tenant-alpha
  clusterRoleBindings:
    clusterRoleRefs:
      - view

---
# -----------------------------------------------------------------------------
# Edge Case 5b: BD-generated SA shared by multiple BDs — second owner
# Same SA as 5a, different role bindings.
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-shared-generated-sa-b
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-shared-gen-b
  subjects:
    - kind: ServiceAccount
      name: shared-generated-sa
      namespace: tenant-alpha
  roleBindings:
    - clusterRoleRefs:
        - edit
      namespace: tenant-alpha

---
# -----------------------------------------------------------------------------
# Edge Case 6: Missing ClusterRole reference (deliberate RoleRefsValid: False)
# References "nonexistent-cluster-role" which no RoleDefinition creates and is
# not a built-in K8s role. This BD should reconcile successfully (Ready: True)
# but with RoleRefsValid: False and a Warning event.
# The controller will requeue at RoleRefRequeueInterval (10s) until the role
# appears.
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-missing-clusterrole
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-missing-cr
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: missing-role-testers@example.com
  clusterRoleBindings:
    clusterRoleRefs:
      - nonexistent-cluster-role

---
# -----------------------------------------------------------------------------
# Edge Case 7: Missing Role reference (deliberate RoleRefsValid: False)
# References "nonexistent-role" as a roleRef in tenant-alpha. The Role does not
# exist in that namespace. Again: Ready: True, RoleRefsValid: False.
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-missing-role
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-missing-role
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: missing-role-testers@example.com
  roleBindings:
    - roleRefs:
        - nonexistent-role
      namespace: tenant-alpha

---
# -----------------------------------------------------------------------------
# Edge Case 8: Mixed valid + missing role references
# Has both valid refs (view, t-caas-security-auditor) and invalid refs
# (phantom-cluster-role, phantom-namespace-role). Tests that:
#   - Valid bindings are still created
#   - RoleRefsValid: False lists only the missing ones
#   - The Warning event enumerates both missing refs
# -----------------------------------------------------------------------------
apiVersion: authorization.t-caas.telekom.com/v1alpha1
kind: BindDefinition
metadata:
  name: bd-edge-mixed-refs
  labels:
    app.kubernetes.io/name: auth-operator
    app.kubernetes.io/managed-by: kustomize
    t-caas.telekom.com/purpose: edge-case
spec:
  targetName: edge-mixed-refs
  subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: mixed-ref-testers@example.com
  clusterRoleBindings:
    clusterRoleRefs:
      # valid — built-in K8s role
      - view
      # valid — created by rd-security-auditor RoleDefinition
      - t-caas-security-auditor
      # MISSING — does not exist anywhere
      - phantom-cluster-role
  roleBindings:
    - clusterRoleRefs:
        - edit
      roleRefs:
        # MISSING — no such Role in tenant-alpha
        - phantom-namespace-role
      namespace: tenant-alpha